#include "cssminifyproc.h"

cssMinifyProc::cssMinifyProc(sourceCode src) {
    setOldSource(src);
}

bool cssMinifyProc::specSelectorStart(char c) {
    return c == '.' || c == '#' || c == '*' || c == '[';
}

bool cssMinifyProc::specSelectorEnd(char c) {
    return c == ')' || c == ']' || c == '*';
}

void cssMinifyProc::minimize() {
    bool stat = false;

    for (oldSource.jumpToStart(); isNextChar(); oldSource.jumpNext()) {
       switch (oldSource.charAt()) {
            case '{':
                stat = true;
                newSource.append(oldSource.charAt());
                break;
            case '}':
                stat = false;
                newSource.append(oldSource.charAt());
                break;
            case '\'':
                quotationMarks('\'');
                break;
            case '"':
                quotationMarks('"');
                break;
            default:
                if (isWhiteSpace(oldSource.charAt()) != -1) {
                    int j = oldSource.getIndex() - 1;
                    while (isWhiteSpace(isNextChar() ? oldSource.getNextChar() : 'a') != -1);
                    if(j > -1 && isNextChar()) {
                        if(stat) {
                            if(isWord(oldSource.charAt(j)) && isWord(oldSource.charAt(oldSource.getIndex() + 1))) {
                                newSource.append(' ');
                            }
                        } else if ((isWord(oldSource.charAt(j)) || specSelectorEnd(oldSource.charAt(j)))
                                    && (isWord(oldSource.charAt(oldSource.getIndex() + 1)) || specSelectorStart(oldSource.charAt(oldSource.getIndex() + 1)))) {
                            newSource.append(' ');
                        }
                    }
                } else {
                    newSource.append(oldSource.charAt(oldSource.getIndex()));
                }
        }
    }
}
